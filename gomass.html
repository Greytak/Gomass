<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
<head>
  <meta charset="utf-8">
  <title>Gomass</title>
</head>
<body>
</body>
<script>
//-----------------------------------------------------------
var grillex = 8;
var grilley = 2;
var therequest = {};
var canvas_source = "";
var canvas_destination = "";
//-----------------------------------------------------------
create_canvas();
create_buttons();
create_listparties();
create_buttons_party();
//-----------------------------------------------------------
goajaxrequete();
//-----------------------------------------------------------
//-----------------------------------------------------------
function processajaxresponse() {
  therequest["command"] = "";
  turnswap = document.getElementById("turnswap");
  php_json = JSON.parse(tmpresp);
  if (typeof php_json != "undefined") {
    if (typeof php_json["current_party"] != 'undefined')
      therequest['selected_party'] = php_json["current_party"];
    if (php_json["yourturn"]== 1) {
      turnswap.setAttribute("value", "end of turn");
      turnswap.disabled = false;
    }
    if (php_json["yourturn"]== 0) {
      turnswap.setAttribute("value", "opponent turn");
      turnswap.disabled = true;
    }
    if (typeof php_json["grille"] != 'undefined') display();
    if (typeof php_json["partiesarray"] != 'undefined') fill_listparties();
  }
  myTimeout = setTimeout ("goajaxrequete()", 750);
}
//-----------------------------------------------------------
function display() {
  for (i = 0; i < grillex; i++) {
    for (j = 0; j < grilley; j++) {
      canvas_txt = "canvas"+i+"-"+j;
      canvas_tmp = document.getElementById(canvas_txt);
      canvas_tmp.clear();
      if (php_json['grille'][i][j]['carte']==1) {
        canvas_tmp.draw();
      }
    }
  }
}
//-----------------------------------------------------------
function create_listparties() {
  var element = document.createElement("select");
  element.id = "listparties";
  element.style.position = "absolute";
  element.style.left = 480;
  element.style.top = 303;
  element.onclick = function() {
    therequest['selected_party'] = this[this.selectedIndex].value;
  };
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function fill_listparties() {  
  var listparties = document.getElementById("listparties");
  listparties.innerHTML = "";
  if (typeof php_json['partiesarray'] != 'undefined') {//??
    for (var key in php_json['partiesarray']) {
      var value = php_json['partiesarray'][key];
      var option = document.createElement("option");
      if (therequest['selected_party']==value["id"]) option.selected = true;
      option.value = value["id"];
      option.innerHTML = value["id"];
      listparties.appendChild(option);
    }
  }
}
//-----------------------------------------------------------
function goajaxrequete()
{
  if (typeof myTimeout != 'undefined')
    clearTimeout(myTimeout);
  str_json= JSON.stringify(therequest);
  console.log(str_json);
  var xmlhttp=new XMLHttpRequest();
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      tmpresp= xmlhttp.responseText;
      //console.log("tt--"+tmpresp+"--tt");
      processajaxresponse();
    } else {
      //console.log('wrong');
    }
  }
  xmlhttp.open("POST", "gomass.php", true)
  xmlhttp.setRequestHeader("Content-type", "application/json")
  xmlhttp.send(str_json);
}
//-----------------------------------------------------------
function create_canvas() {
  for (i = 0; i < grillex; i++) {
    for (j = 0; j < grilley; j++) {
      var canvas = document.createElement('canvas');
      canvas.id     = "canvas"+i+"-"+j;
      canvas.width  = 100;
      canvas.height = 150;
      canvas.style.zIndex   = 8;
      canvas.style.position = "absolute";
      canvas.style.left = i*100;
      canvas.style.top = j*150;
      canvas.style.border = "1px solid grey";
      canvas.x = i;
      canvas.y = j;
      canvas.imagej = new Image();
      canvas.onclick = function() {
        //if (this.imagej.src!='') {
        if (php_json['grille'][this.x][this.y]['carte']==1) {
          canvas_source= this.id;
        }
        else {
          therequest["command"] = "gomove";
          therequest["desx"] = this.x;
          therequest["desy"] = this.y;
          canvas_destination= this.id;
          canvas_tmp = document.getElementById(canvas_source);
          therequest["srcx"] = canvas_tmp.x;
          therequest["srcy"] = canvas_tmp.y;
          goajaxrequete();
        }
      };
      canvas.clear = function() {
        ctx = this.getContext("2d");
        ctx.clearRect(0, 0, 100, 150);
      };
      canvas.draw = function() {
        ctx = this.getContext("2d");
        ctx.beginPath();
        //ctx.fillStyle = "black";
        ctx.rect(0, 0, 12, 12);
        ctx.fillText(" 8", 0, 10);
        ctx.fillText("Archimage", 22, 10);
        ctx.rect(87, 138, 12, 12);
        ctx.fillText(" 8", 87, 148);
        ctx.rect(0, 138, 12, 12);
        ctx.fillText(" 8", 0, 148);
        ctx.fillText(" +1 dÃ©gats des sorts", 5, 100);
        this.imagej.src = 'darth-vader.jpg';
        ctx.drawImage(this.imagej, 10, 20, 75, 60);
        ctx.stroke();
        //ctx.fill();
      };
      document.body.appendChild(canvas);
    }
  }
}
//-----------------------------------------------------------
function create_buttons() {
  var element = document.createElement("input");
  element.type = "button";
  element.id = "turnswap";
  element.style.position = "absolute";
  element.style.left = 60;
  element.style.top = 303;
  element.onclick = function() {
    therequest["command"] = "endturn";
    goajaxrequete();
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "reset";
  element.id = "resetgame";
  element.style.position = "absolute";
  element.style.left = 3;
  element.style.top = 303;
  element.onclick = function() {
    therequest["command"] = "resetgame";
    goajaxrequete();
  }
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function create_buttons_party() {
  var element = document.createElement("input");
  element.type = "button";
  element.value = "join";
  element.id = "joinparty";
  element.style.position = "absolute";
  element.style.left = 270;
  element.style.top = 303;
  element.onclick = function() {
    therequest["command"] = "joinparty";
    goajaxrequete();
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "create";
  element.id = "createparty";
  element.style.position = "absolute";
  element.style.left = 330;
  element.style.top = 303;
  element.onclick = function() {
    therequest["command"] = "createparty";
    goajaxrequete();
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "quit";
  element.id = "quitparty";
  element.style.position = "absolute";
  element.style.left = 410;
  element.style.top = 303;
  element.onclick = function() {
    therequest["command"] = "quitparty";
    goajaxrequete();
  }
  document.body.appendChild(element);
}
//-----------------------------------------------------------
</script>
</html>
