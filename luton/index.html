<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
<head>
  <meta charset="utf-8">
  <title>Gomass</title>
</head>
<body>
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
//-----------------------------------------------------------
var socket = io.connect('http://localhost:3000');
//-----------------------------------------------------------
// display sender login and chat messgae
socket.on('sendall', function(data) {
  console.log('sendall');
  document.getElementById('generalchat').value += data.login + ' : ' + data.message + '\n';
  document.getElementById('messagechat').value = '';
})
//-----------------------------------------------------------
// add partie_name to select 'listparties' and select it if you are the creator
socket.on('createparty', function(data) {
  console.log('createparty '+data.partie_name);
  var option = document.createElement("option");
  option.value = data.partie_name;
  option.innerHTML = data.partie_name;
  if (data.login==document.getElementById('login').value) option.selected = true;
  document.getElementById("listparties").appendChild(option);
})
//-----------------------------------------------------------
// add partie_name to select 'listparties' and select it if you are the creator
socket.on('joinparty', function(data) {
  console.log('joinparty '+data.partie_name);
})
//-----------------------------------------------------------
var grillex = 8;
var grilley = 2;
var therequest = {};
var canvas_source = "";
var canvas_destination = "";
//-----------------------------------------------------------
draw_card(20,40,'images/card1.jpg', 89, 149);
draw_card(130,40,'images/card2.jpg', 73, 146);
draw_card(240,40,'images/card3.jpg', 89, 146);
draw_card(350,40,'images/card4.jpg', 89, 146);
draw_card(460,40,'images/card5.jpg', 100, 149);
draw_card(570,40,'images/card6.jpg', 83, 149);
draw_card(680,40,'images/card7.jpg', 88, 149);
draw_card(790,40,'images/card8.jpg', 91, 149);
//create_canvas();
create_login();
create_chat();
create_buttons();
create_listparties();
create_buttons_party();
//-----------------------------------------------------------
//-----------------------------------------------------------
//-----------------------------------------------------------
function create_image() {

}
//-----------------------------------------------------------
function my_draw_text(text, x, y, context) {
  //display a text in black with a white outline
  context.strokeStyle = 'white';
  context.lineWidth = 1.8;
  context.strokeText(text, x, y);
  context.fillStyle = 'black';
  context.fillText(text, x, y);
}
//-----------------------------------------------------------
function draw_card(x, y, image_path, imgx, imgy) {
  var canvas = document.createElement('canvas');
  //canvas.id     = "canvas"+i+"-"+j;
  canvas.width  = 100;
  canvas.height = 150;
  canvas.style.zIndex   = 8;
  canvas.style.position = "absolute";
  canvas.style.left = x;
  canvas.style.top = y;
  canvas.style.border = "1px solid grey";
  //canvas.x = i; //canvas.y = j;
  canvas.imagej = new Image();

  var ctx = canvas.getContext("2d");

  canvas.imagej.src = image_path;
  canvas.imagej.onload = function(){
    ctx.drawImage(canvas.imagej, 5, 1, imgx, imgy);
    ctx.stroke();

    //ctx.beginPath();
    ctx.rect(0, 0, 11, 11);  ctx.strokeStyle = 'black';  ctx.stroke();
    my_draw_text('8', 3, 9, ctx)
    my_draw_text('Archimage', 22, 10, ctx)

    ctx.rect(88, 138, 11, 11);  ctx.strokeStyle = 'black';  ctx.stroke();
    my_draw_text('8', 90, 147, ctx)
    ctx.rect(0, 138, 11, 11);  ctx.strokeStyle = 'black';  ctx.stroke();
    my_draw_text('8', 3, 147, ctx)
    my_draw_text(' +1 dégats des sorts', 5, 100, ctx)
  }

  document.body.appendChild(canvas);
}
//-----------------------------------------------------------
function create_login() {
  var element = document.createElement("span");
  element.style.position = "absolute";
  element.style.left = 3;
  element.style.top = 333;
  element.innerHTML = 'login ';
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.id = 'login';
  element.value= getName(6, 6, '', '');
  element.size = 6;
  element.style.position = "absolute";
  element.style.left = 45;
  element.style.top = 333;
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function create_chat() {
  var element = document.createElement("textarea");
  element.id = "roomchat";
  element.readonly = true;
  element.cols = 15;
  element.rows = 3;
  element.style.position = "absolute";
  element.style.left = 700;
  element.style.top = 303;
  document.body.appendChild(element);
  var element = document.createElement("textarea");
  element.id = "generalchat";
  element.readonly = true;
  element.cols = 15;
  element.rows = 3;
  element.style.position = "absolute";
  element.style.left = 550;
  element.style.top = 303;
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.id = "messagechat";
  element.size = 12;
  element.style.position = "absolute";
  element.style.left = 270;
  element.style.top = 335;
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.id = "sendroom";
  element.value = "sendroom";
  element.style.position = "absolute";
  element.style.left = 380;
  element.style.top = 335;
  element.onclick = function() {
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.id = "sendall";
  element.value = "sendall";
  element.style.position = "absolute";
  element.style.left = 460;
  element.style.top = 335;
  element.onclick = function() {
    // ask server to send a chat message to all socket
    socket.emit('sendall', {
        message: document.getElementById('messagechat').value,
        login: document.getElementById('login').value
    });
  }
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function create_listparties() {
  var element = document.createElement("select");
  element.id = "listparties";
  element.style.position = "absolute";
  element.style.left = 460;
  element.style.top = 303;
  element.onclick = function() {
    therequest['selected_party'] = this[this.selectedIndex].value;
  };
  //add an empty option
  var option = document.createElement("option");
  element.appendChild(option);
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function create_buttons() {
  var element = document.createElement("input");
  element.type = "button";
  element.id = "turnswap";
  element.style.position = "absolute";
  element.style.left = 80;
  element.style.top = 303;
  element.onclick = function() {
    socket.emit('turnswap', {
        message: document.getElementById('messagechat').value,
        login: document.getElementById('login').value
    });
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "reset";
  element.id = "resetgame";
  element.style.position = "absolute";
  element.style.left = 3;
  element.style.top = 303;
  element.onclick = function() {
    socket.emit('resetgame', {
        message: document.getElementById('messagechat').value,
        login: document.getElementById('login').value
    });
  }
  document.body.appendChild(element);
}
//-----------------------------------------------------------
function create_buttons_party() {
  var element = document.createElement("input");
  element.type = "button";
  element.value = "create";
  element.id = "createparty";
  element.style.position = "absolute";
  element.style.left = 230;
  element.style.top = 303;
  element.onclick = function() {
    console.log('createparty click');
    if (document.getElementById('partie_name').value=='')
      document.getElementById('partie_name').value= getName(6, 6, '', '');
    socket.emit('createparty', {
      partie_name: document.getElementById('partie_name').value,
      login: document.getElementById('login').value
    });
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.id = 'partie_name';
  element.size = 6;
  element.style.position = "absolute";
  element.style.left = 290;
  element.style.top = 303;
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "quit";
  element.id = "quitparty";
  element.style.position = "absolute";
  element.style.left = 360;
  element.style.top = 303;
  element.onclick = function() {
    console.log('quitparty click');
    socket.emit('quitparty', {
        message: document.getElementById('messagechat').value,
        login: document.getElementById('login').value
    });
  }
  document.body.appendChild(element);
  var element = document.createElement("input");
  element.type = "button";
  element.value = "join";
  element.id = "joinparty";
  element.style.position = "absolute";
  element.style.left = 410;
  element.style.top = 303;
  element.onclick = function() {
    var listparties= document.getElementById("listparties");
    var partie_name= listparties[listparties.selectedIndex].value;
    console.log('joinparty click '+partie_name);
    if (partie_name!='')
      socket.emit('joinparty', {
        partie_name: partie_name,
        login: document.getElementById('login').value
      });
  }
  document.body.appendChild(element);
}
//-----------------------------------------------------------
/*
therequest['selected_party'] = this[this.selectedIndex].value;

var option = document.createElement("option");
option.value = data.partie_name;
option.innerHTML = data.partie_name;
if (data.login==document.getElementById('login').value) option.selected = true;
document.getElementById("listparties").appendChild(option);
*/







//-----------------------------------------------------------
//random name generator from
//http://leapon.net/files/namegen.html
//-----------------------------------------------------------
function rnd(minv, maxv){
  if (maxv < minv) return 0;
  return Math.floor(Math.random()*(maxv-minv+1)) + minv;
}

function getName(minlength, maxlength, prefix, suffix)
{
  prefix = prefix || '';
  suffix = suffix || '';
  //these weird character sets are intended to cope with the nature of English (e.g. char 'x' pops up less frequently than char 's')
  //note: 'h' appears as consonants and vocals
  var vocals = 'aeiouyh' + 'aeiou' + 'aeiou';
  var cons = 'bcdfghjklmnpqrstvwxz' + 'bcdfgjklmnprstvw' + 'bcdfgjklmnprst';
  var allchars = vocals + cons;
  //minlength += prefix.length;
  //maxlength -= suffix.length;
  var length = rnd(minlength, maxlength) - prefix.length - suffix.length;
  if (length < 1) length = 1;
  //alert(minlength + ' ' + maxlength + ' ' + length);
  var consnum = 0;
  //alert(prefix);
  /*if ((prefix.length > 1) && (cons.indexOf(prefix[0]) != -1) && (cons.indexOf(prefix[1]) != -1)) {
    //alert('a');
    consnum = 2;
  }*/
  if (prefix.length > 0) {
    for (var i = 0; i < prefix.length; i++) {
      if (consnum == 2) consnum = 0;
      if (cons.indexOf(prefix[i]) != -1) {
        consnum++;
      }
    }
  }
  else {
    consnum = 1;
  }

  var name = prefix;

  for (var i = 0; i < length; i++)
  {
    //if we have used 2 consonants, the next char must be vocal.
    if (consnum == 2)
    {
      touse = vocals;
      consnum = 0;
    }
    else touse = allchars;
    //pick a random character from the set we are goin to use.
    c = touse.charAt(rnd(0, touse.length - 1));
    name = name + c;
    if (cons.indexOf(c) != -1) consnum++;
  }
  name = name.charAt(0).toUpperCase() + name.substring(1, name.length) + suffix;
  return name;
}
//-----------------------------------------------------------







//-----------------------------------------------------------
//-----------------------------------------------------------
function fill_listparties() {
  var listparties = document.getElementById("listparties");
  listparties.innerHTML = "";
  if (typeof php_json['partiesarray'] != 'undefined') {//??
    for (var key in php_json['partiesarray']) {
      var value = php_json['partiesarray'][key];
      var option = document.createElement("option");
      if (therequest['selected_party']==value["id"]) option.selected = true;
      option.value = value["id"];
      option.innerHTML = value["id"];
      listparties.appendChild(option);
    }
  }
}
//-----------------------------------------------------------
function goajaxrequete()
{
  if (typeof myTimeout != 'undefined')
    clearTimeout(myTimeout);
  str_json= JSON.stringify(therequest);
  console.log(str_json);
  var xmlhttp=new XMLHttpRequest();
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      tmpresp= xmlhttp.responseText;
      //console.log("tt--"+tmpresp+"--tt");
      processajaxresponse();
    } else {
      //console.log('wrong');
    }
  }
  xmlhttp.open("POST", "gomass.php", true)
  xmlhttp.setRequestHeader("Content-type", "application/json")
  xmlhttp.send(str_json);
}
//-----------------------------------------------------------
function create_canvas() {
  for (i = 0; i < grillex; i++) {
    for (j = 0; j < grilley; j++) {
      var canvas = document.createElement('canvas');
      canvas.id     = "canvas"+i+"-"+j;
      canvas.width  = 100;
      canvas.height = 150;
      canvas.style.zIndex   = 8;
      canvas.style.position = "absolute";
      canvas.style.left = i*100;
      canvas.style.top = j*150;
      canvas.style.border = "1px solid grey";
      canvas.x = i;
      canvas.y = j;
      canvas.imagej = new Image();
      canvas.onclick = function() {
        //if (this.imagej.src!='') {
        if (php_json["theparty"]['grille'][this.x][this.y]['carte']==1) {
          canvas_source= this.id;
        }
        else {
          therequest["command"] = "gomove";
          therequest["desx"] = this.x;
          therequest["desy"] = this.y;
          canvas_destination= this.id;
          canvas_tmp = document.getElementById(canvas_source);
          therequest["srcx"] = canvas_tmp.x;
          therequest["srcy"] = canvas_tmp.y;
          goajaxrequete();
        }
      };
      canvas.clear = function() {
        ctx = this.getContext("2d");
        ctx.clearRect(0, 0, 100, 150);
      };
      canvas.draw = function() {
        ctx = this.getContext("2d");
        ctx.beginPath();
        //ctx.fillStyle = "black";
        ctx.rect(0, 0, 12, 12);
        ctx.fillText(" 8", 0, 10);
        ctx.fillText("Archimage", 22, 10);
        ctx.rect(87, 138, 12, 12);
        ctx.fillText(" 8", 87, 148);
        ctx.rect(0, 138, 12, 12);
        ctx.fillText(" 8", 0, 148);
        ctx.fillText(" +1 dégats des sorts", 5, 100);
        this.imagej.src = 'images/carte1.jpg';
        ctx.drawImage(this.imagej, 10, 20, 75, 60);
        ctx.stroke();
        //ctx.fill();
      };
      document.body.appendChild(canvas);
    }
  }
}
//-----------------------------------------------------------
function tteessttoo() {
  var canvas = document.createElement('canvas');
  canvas.id     = "canvas"+i+"-"+j;
  canvas.width  = 100;
  canvas.height = 150;
  canvas.style.zIndex   = 8;
  canvas.style.position = "absolute";
  canvas.style.left = i*100;
  canvas.style.top = j*150;
  canvas.style.border = "1px solid grey";
  canvas.x = i;
  canvas.y = j;
  canvas.imagej = new Image();
  canvas.draw = function() {
    ctx = this.getContext("2d");
    ctx.beginPath();
    //ctx.fillStyle = "black";
    ctx.rect(0, 0, 12, 12);
    ctx.fillText(" 8", 0, 10);
    ctx.fillText("Archimage", 22, 10);
    ctx.rect(87, 138, 12, 12);
    ctx.fillText(" 8", 87, 148);
    ctx.rect(0, 138, 12, 12);
    ctx.fillText(" 8", 0, 148);
    ctx.fillText(" +1 dégats des sorts", 5, 100);
    this.imagej.src = 'darth-vader.jpg';
    ctx.drawImage(this.imagej, 10, 20, 75, 60);
    ctx.stroke();
    //ctx.fill();
  };
  document.body.appendChild(canvas);
}
//-----------------------------------------------------------
</script>
</html>
